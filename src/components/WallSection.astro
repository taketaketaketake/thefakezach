---
// No longer importing static data - will be fetched dynamically
---

<section id="wall" class="w-full">
  <h2 class="text-2xl font-bold text-white mb-6">The Wall</h2>

  <!-- âœ… Netlify-powered form -->
  <form
    name="wall"
    method="POST"
    data-netlify="true"
    netlify-honeypot="bot-field"
    action="/#wall"
    onsubmit="event.target.classList.add('submitted')"
    class="mb-8 bg-zinc-900/50 border border-zinc-800 rounded-2xl p-4 sm:p-6 space-y-3 transition-all duration-300"
  >
    <input type="hidden" name="form-name" value="wall" />
    <p class="hidden">
      <label>
        Donâ€™t fill this out if youâ€™re human: <input name="bot-field" />
      </label>
    </p>

    <div class="form-fields space-y-3">
      <input
        type="text"
        name="name"
        required
        placeholder="Your name"
        class="w-full bg-zinc-950 border border-zinc-800 rounded-xl p-3 text-sm text-zinc-200 focus:outline-none focus:ring-2 focus:ring-pink-600"
      />
      <textarea
        name="message"
        rows="3"
        required
        placeholder="Write something..."
        class="w-full bg-zinc-950 border border-zinc-800 rounded-xl p-3 text-sm text-zinc-200 focus:outline-none focus:ring-2 focus:ring-pink-600 resize-none"
      ></textarea>

      <div class="flex justify-end">
        <button
          type="submit"
          class="px-5 py-2.5 bg-pink-600 text-white text-sm font-semibold rounded-xl hover:bg-pink-700 transition shadow-md"
        >
          Post
        </button>
      </div>
    </div>

    <div class="thank-you-message hidden text-center text-pink-400 font-medium py-2">
      Thanks for leaving a message! ðŸ’¬
    </div>
  </form>

  <!-- ðŸ’¬ Posts -->
  <div id="posts-container" class="space-y-4">
    <!-- Loading state -->
    <div id="loading-state" class="text-center py-8 text-zinc-400">
      <div class="animate-pulse">Loading posts...</div>
    </div>
    
    <!-- Error state -->
    <div id="error-state" class="hidden text-center py-8 text-red-400">
      <p>Failed to load posts. Please try refreshing the page.</p>
    </div>
    
    <!-- Empty state -->
    <div id="empty-state" class="hidden text-center py-8 text-zinc-500">
      <p>No posts yet. Be the first to leave a message! ðŸ’¬</p>
    </div>
    
    <!-- Posts will be populated here -->
    <div id="posts-list"></div>
  </div>
</section>

<style>
/* âœ… Hide form after submission */
form.submitted .form-fields {
  display: none;
}
form.submitted .thank-you-message {
  display: block;
  opacity: 0;
  animation: fadeIn 0.5s ease-in-out forwards;
}

/* âœ¨ Fade animation */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(4px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  let posts = [];
  let userReactions = JSON.parse(localStorage.getItem("userReactions") || "{}");

  // Elements
  const loadingState = document.getElementById("loading-state");
  const errorState = document.getElementById("error-state");
  const emptyState = document.getElementById("empty-state");
  const postsList = document.getElementById("posts-list");
  const form = document.querySelector('form[name="wall"]');

  async function fetchPosts() {
    try {
      const response = await fetch("/.netlify/functions/get-wall-posts");
      if (!response.ok) {
        // Fallback for local development
        if (response.status === 404 && window.location.hostname === 'localhost') {
          console.warn("Running in local mode - functions not available");
          return [];
        }
        throw new Error(`HTTP ${response.status}`);
      }
      
      const data = await response.json();
      return data.posts || [];
    } catch (error) {
      console.error("Failed to fetch posts:", error);
      // Return empty array for local development
      if (window.location.hostname === 'localhost') {
        return [];
      }
      throw error;
    }
  }

  async function updateReaction(postId, emoji, action) {
    try {
      const response = await fetch("/.netlify/functions/update-reactions", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ postId, emoji, action }),
      });
      
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      
      const data = await response.json();
      return data.reactions;
    } catch (error) {
      console.error("Failed to update reaction:", error);
      throw error;
    }
  }

  function autoLinkUrls(text) {
    return text.replace(
      /(https?:\/\/[^\s]+)/g,
      '<a href="$1" target="_blank" rel="noopener noreferrer" class="text-pink-400 hover:underline break-all">$1</a>'
    );
  }

  function renderPosts() {
    if (posts.length === 0) {
      loadingState.classList.add("hidden");
      emptyState.classList.remove("hidden");
      return;
    }

    loadingState.classList.add("hidden");
    emptyState.classList.add("hidden");
    
    postsList.innerHTML = posts.map(post => `
      <div class="bg-zinc-900/50 border border-zinc-800 rounded-2xl p-4 sm:p-6 transition hover:border-pink-500/20">
        <div class="flex items-start justify-between mb-2">
          <div>
            <p class="text-white font-medium text-sm">${post.name}</p>
            <p class="text-zinc-500 text-xs">${post.date}</p>
          </div>
        </div>
        
        <p class="text-zinc-300 text-sm leading-relaxed whitespace-pre-line break-words mb-3">
          ${autoLinkUrls(post.message)}
        </p>
        
        <div class="flex gap-3 mt-2 text-lg text-zinc-400">
          ${["ðŸ‘", "â¤ï¸", "ðŸ”¥", "ðŸ˜‚", "ðŸ’¡"].map(emoji => `
            <button
              type="button"
              class="reaction-btn select-none transition transform hover:scale-110 ${userReactions[post.id] === emoji ? 'text-pink-400' : ''}"
              data-post-id="${post.id}"
              data-emoji="${emoji}"
              aria-label="React with ${emoji}"
            >
              ${emoji}
              <span class="count text-xs text-zinc-500 ml-1">${post.reactions[emoji] || 0}</span>
            </button>
          `).join('')}
        </div>
      </div>
    `).join('');

    // Add event listeners to reaction buttons
    document.querySelectorAll(".reaction-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
        const postId = btn.dataset.postId;
        const emoji = btn.dataset.emoji;
        const currentUserReaction = userReactions[postId];
        
        try {
          let action, newUserReaction;
          
          if (currentUserReaction === emoji) {
            // Remove reaction
            action = "decrement";
            newUserReaction = null;
          } else {
            // Add new reaction (and remove old one if exists)
            if (currentUserReaction) {
              await updateReaction(postId, currentUserReaction, "decrement");
            }
            action = "increment";
            newUserReaction = emoji;
          }
          
          const updatedReactions = await updateReaction(postId, emoji, action);
          
          // Update local state
          userReactions[postId] = newUserReaction;
          localStorage.setItem("userReactions", JSON.stringify(userReactions));
          
          // Update post reactions and re-render
          const post = posts.find(p => p.id === postId);
          if (post) {
            post.reactions = updatedReactions;
            renderPosts();
          }
          
        } catch (error) {
          console.error("Failed to update reaction:", error);
        }
      });
    });
  }

  // Load posts
  try {
    posts = await fetchPosts();
    renderPosts();
  } catch (error) {
    loadingState.classList.add("hidden");
    errorState.classList.remove("hidden");
  }

  // Handle form submission
  if (form) {
    form.addEventListener("submit", () => {
      // Refresh posts after a delay to allow form processing
      setTimeout(() => {
        fetchPosts().then(newPosts => {
          posts = newPosts;
          renderPosts();
        }).catch(console.error);
      }, 2000);
    });
  }
});
</script>
    
