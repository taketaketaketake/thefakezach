---
import posts from "../data/wall.json" assert { type: "json" };
---

<section id="wall" class="w-full">
  <h2 class="text-2xl font-bold text-white mb-6">The Wall</h2>

  <!-- âœ… Netlify-powered form -->
  <form
    name="wall"
    method="POST"
    data-netlify="true"
    netlify-honeypot="bot-field"
    onsubmit="event.target.classList.add('submitted')"
    class="mb-8 bg-zinc-900/50 border border-zinc-800 rounded-2xl p-4 sm:p-6 space-y-3 transition-all duration-300"
  >
    <input type="hidden" name="form-name" value="wall" />
    <p class="hidden">
      <label>
        Donâ€™t fill this out if youâ€™re human: <input name="bot-field" />
      </label>
    </p>

    <div class="form-fields space-y-3">
      <input
        type="text"
        name="name"
        required
        placeholder="Your name"
        class="w-full bg-zinc-950 border border-zinc-800 rounded-xl p-3 text-sm text-zinc-200 focus:outline-none focus:ring-2 focus:ring-pink-600"
      />
      <textarea
        name="message"
        rows="3"
        required
        placeholder="Write something..."
        class="w-full bg-zinc-950 border border-zinc-800 rounded-xl p-3 text-sm text-zinc-200 focus:outline-none focus:ring-2 focus:ring-pink-600 resize-none"
      ></textarea>

      <div class="flex justify-end">
        <button
          type="submit"
          class="px-5 py-2.5 bg-pink-600 text-white text-sm font-semibold rounded-xl hover:bg-pink-700 transition shadow-md"
        >
          Post
        </button>
      </div>
    </div>

    <div class="thank-you-message hidden text-center text-pink-400 font-medium py-2">
      Thanks for leaving a message! ðŸ’¬
    </div>
  </form>

  <!-- ðŸ’¬ Posts -->
  <div class="space-y-4">
    {posts.map((post, index) => (
      <div
        class="bg-zinc-900/50 border border-zinc-800 rounded-2xl p-4 sm:p-6 transition hover:border-pink-500/20"
      >
        <div class="flex items-start justify-between mb-2">
          <div>
            <p class="text-white font-medium text-sm">{post.name}</p>
            <p class="text-zinc-500 text-xs">
              {post.date ||
                new Date().toLocaleDateString("en-US", {
                  month: "long",
                  day: "numeric",
                  year: "numeric",
                })}
            </p>
          </div>
        </div>

        <!-- Auto-link URLs -->
        <p
          class="text-zinc-300 text-sm leading-relaxed whitespace-pre-line break-words mb-3"
          set:html={post.message.replace(
            /(https?:\/\/[^\s]+)/g,
            '<a href="$1" target="_blank" rel="noopener noreferrer" class="text-pink-400 hover:underline break-all">$1</a>'
          )}
        ></p>

        <!-- ðŸŽ‰ Emoji Reactions -->
        <div class="flex gap-3 mt-2 text-lg text-zinc-400">
          {["ðŸ‘", "â¤ï¸", "ðŸ”¥", "ðŸ˜‚", "ðŸ’¡"].map((emoji) => (
            <button
              type="button"
              class="reaction-btn select-none transition transform hover:scale-110"
              data-index={index}
              data-emoji={emoji}
              aria-label={`React with ${emoji}`}
            >
              {emoji}
              <span class="count text-xs text-zinc-500 ml-1">0</span>
            </button>
          ))}
        </div>
      </div>
    ))}
  </div>
</section>

<style>
/* âœ… Hide form after submission */
form.submitted .form-fields {
  display: none;
}
form.submitted .thank-you-message {
  display: block;
  opacity: 0;
  animation: fadeIn 0.5s ease-in-out forwards;
}

/* âœ¨ Fade animation */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(4px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>

<script>
    document.addEventListener("DOMContentLoaded", () => {
      const storageKey = "wallReactions";
      const saved = JSON.parse(localStorage.getItem(storageKey) || "{}");
    
      document.querySelectorAll(".reaction-btn").forEach((btn) => {
        const postIndex = btn.dataset.index;
        const emoji = btn.dataset.emoji;
        const key = `${postIndex}`;
    
        const countSpan = btn.querySelector(".count");
        const savedReaction = saved[key]?.emoji;
        const savedCount = saved[key]?.counts?.[emoji] || 0;
    
        // Load saved counts
        countSpan.textContent = savedCount;
    
        // Highlight chosen emoji if applicable
        if (savedReaction === emoji) btn.classList.add("text-pink-400");
    
        btn.addEventListener("click", () => {
          const allButtons = document.querySelectorAll(
            `.reaction-btn[data-index='${postIndex}']`
          );
    
          // Initialize structure if needed
          if (!saved[key]) saved[key] = { emoji: null, counts: {} };
          const currentReaction = saved[key].emoji;
    
          // Remove previous reaction highlight
          allButtons.forEach((b) => b.classList.remove("text-pink-400"));
    
          if (currentReaction === emoji) {
            // Undo the reaction
            saved[key].emoji = null;
            saved[key].counts[emoji] = Math.max((saved[key].counts[emoji] || 1) - 1, 0);
            countSpan.textContent = saved[key].counts[emoji];
          } else {
            // Switch to new emoji
            saved[key].emoji = emoji;
            saved[key].counts[emoji] = (saved[key].counts[emoji] || 0) + 1;
            countSpan.textContent = saved[key].counts[emoji];
            btn.classList.add("text-pink-400");
          }
    
          // Save updates
          localStorage.setItem(storageKey, JSON.stringify(saved));
    
          // Subtle bounce
          btn.classList.add("scale-125");
          setTimeout(() => btn.classList.remove("scale-125"), 200);
        });
      });
    });
    </script>
    
